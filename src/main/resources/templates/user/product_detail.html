<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="/src/main/resources/static/css/product_detail.css">
    <title>About us</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #243642;">
            <div class="container">
                <!-- Logo và tên thương hiệu -->
                <a class="navbar-brand d-flex align-items-center" href="index.html"> <i
                        class="fa-brands fa-strava fa-2x me-2 text-light"></i> <span class="fw-bold text-light">Conan
                        Store</span>
                </a>
                <!-- Nút bật/tắt cho thiết bị di động -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Menu điều hướng -->
                <div class="collapse navbar-collapse" id="navbarContent">
                    <!-- Menu chính -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active text-light" href="index.html">Trang chủ</a>
                        </li>
                        <li class="nav-item"><a class="nav-link text-light" href="about.html">Về chúng tôi</a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="product.html">Sản phẩm</a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="contact.html">Liên hệ</a></li>
                    </ul>

                    <!-- search -->
                    <div class="searchbar">
                        <div class="searchbar-wrapper">
                            <div class="searchbar-left">
                                <div class="search-icon-wrapper">
                                    <span class="search-icon searchbar-icon"> <svg xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24">
                                            <path
                                                d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                                            </path>
                                        </svg>
                                    </span>
                                </div>
                            </div>

                            <div class="searchbar-center">
                                <div class="searchbar-input-spacer"></div>

                                <input type="text" class="searchbar-input" maxlength="2048" name="q"
                                    autocapitalize="off" autocomplete="off" title="Search" role="combobox"
                                    placeholder="Search Google">
                            </div>

                            <div class="searchbar-right">
                                <svg class="voice-search" role="button" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24">
                                    <path fill="#4285f4"
                                        d="m12 15c1.66 0 3-1.31 3-2.97v-7.02c0-1.66-1.34-3.01-3-3.01s-3 1.34-3 3.01v7.02c0 1.66 1.34 2.97 3 2.97z">
                                    </path>
                                    <path fill="#34a853" d="m11 18.08h2v3.92h-2z"></path>
                                    <path fill="#fbbc05"
                                        d="m7.05 16.87c-1.27-1.33-2.05-2.83-2.05-4.87h2c0 1.45 0.56 2.42 1.47 3.38v0.32l-1.15 1.18z">
                                    </path>
                                    <path fill="#ea4335"
                                        d="m12 16.93a4.97 5.25 0 0 1 -3.54 -1.55l-1.41 1.49c1.26 1.34 3.02 2.13 4.95 2.13 3.87 0 6.99-2.92 6.99-7h-1.99c0 2.92-2.24 4.93-5 4.93z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Giỏ hàng và tài khoản người dùng -->
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <div class="cart-container">
                                <a href="cart.html">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span id="cart-count">0</span>
                                </a>
                            </div>
                        </li>
                        <li class="nav-item"><a class="nav-link text-light" href="profile.html"> <i
                                    class="fa-solid fa-user me-2"></i>
                            </a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="login.html"> <i
                                    class="fa-solid fa-right-from-bracket me-2"></i></a></li>

                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container mb-5">
        <div class="container mb-5 mt-5">
            <div class="row">
                <!-- Product Info Header -->
                <div class="card-header">
                    <h5 class="text-dark">Thông tin sản phẩm</h5>
                </div>

                <div class="card-body d-flex">
                    <div class="col-sm-6 me-5">
                        <div class="card">
                            <div class="card-body text-center">
                                <img id="product-image" alt="Product Image" width="350" height="300">
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6">
                        <div class="product-info">
                            <h2 id="product-name"></h2>
                            <div class="d-flex">
                                <p class="me-3">Hãng: <span id="product-brand"></span></p>
                                <p class="me-3">Loại: <span id="product-type"></span></p>
                                <p class="me-3">Tình trạng: <span id="product-status"></span></p>
                            </div>

                            <div id="price-and-quantity mt-5">
                                <h5>Giá: <span id="product-price"></span></h5>
                            </div>

                            <div class="d-flex align-items-center mb-3 mt-3">
                                <label for="size-options" class="me-2">Size:</label>
                                <select id="size-options" class="form-select w-auto me-3">
                                    <!-- Options will be injected here -->
                                </select>

                                <label for="color-options" class="me-2">Color:</label>
                                <select id="color-options" class="form-select w-auto">
                                    <!-- Options will be injected here -->
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="product-quantity" class="me-2">Số lượng:</label>
                                <input type="number" id="product-quantity" class="form-control w-auto" min="1"
                                    value="1">
                            </div>

                            <p><span id="product-quantity"></span></p>

                            <div>
                                <div>
                                    <button id="add-to-cart-btn" class="btn btn-dark">Thêm vào giỏ</button>
                                    <button class="btn btn-outline-dark">Thêm vào yêu thích</button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Description Section -->
                <div class="card">
                    <h5>Mô tả</h5>
                    <p id="product-description"></p>
                </div>
            </div>

            <div class="mt-4">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title text-dark">Đánh giá từ khách hàng</h5>
                                <div class="mb-3">
                                    <div class="border p-2 mb-2 bg-light shadow">
                                        <i class="fa-solid fa-face-smile"></i> <strong class="text-dark">Nguyễn Thị
                                            Hoa</strong>
                                        <div class="ms-3">
                                            <i class="fa-solid fa-star" style="color: rgba(255, 208, 0, 0.933);"></i>
                                            <i class="fa-solid fa-star" style="color: rgba(255, 208, 0, 0.933);"></i>
                                            <i class="fa-solid fa-star" style="color: rgba(255, 208, 0, 0.933);"></i>
                                            <i class="fa-solid fa-star" style="color: rgba(255, 208, 0, 0.933);"></i>
                                            <i class="fa-solid fa-star" style="color: rgba(255, 208, 0, 0.933);"></i>
                                        </div>
                                        <p class="ms-3 mt-3 text-dark">Sản phẩm chất lượng! Thời gian giao hàng nhanh
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-5">
            <div class="d-flex flex-column align-items-center text-center mb-3">
                <h4 class="mt-2 text-dark">Sản phẩm liên quan</h4>
            </div>

            <div id="related-products" class="row row-cols-1 row-cols-md-4 g-4 mb-5">
                <!-- Các sản phẩm liên quan sẽ được chèn vào đây -->
            </div>
        </div>



    </div>

    <div th:replace="fragment/header_footer :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">

        </script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const selectedSize = urlParams.get('size');
        let variants = [];

        document.addEventListener("DOMContentLoaded", function () {
            fetchProductDetails(productId, selectedSize);
        });

        // Fetch thông tin sản phẩm và các biến thể
        function fetchProductDetails(productId, selectedSize) {
            fetch(`http://localhost:8080/api/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    // Hiển thị thông tin sản phẩm chính
                    document.getElementById('product-name').textContent = product.name;
                    document.getElementById('product-brand').textContent = product.brand;
                    document.getElementById('product-type').textContent = product.type;
                    document.getElementById('product-description').textContent = product.description;
                    document.getElementById('product-image').src = product.image;
                    document.getElementById('product-status').textContent = product.status === 1 ? 'Còn hàng' : 'Hết hàng';
                    variants = product.variants;
                    console.log(product);
                    // Gọi API để lấy các sản phẩm cùng thương hiệu
                    fetch(`http://localhost:8080/api/products/by-brand?brand=${product.brand}`)
                        .then(response => response.json())
                        .then(relatedProducts => {
                            if (!relatedProducts || relatedProducts.length === 0) {
                                alert("Không có sản phẩm liên quan.");
                            } else {
                                displayRelatedProducts(relatedProducts);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching related products:', error);
                            alert("Có lỗi xảy ra khi tải sản phẩm liên quan.");
                        });

                    const sizeOptionsSelect = document.getElementById('size-options');
                    const uniqueSizes = [...new Set(variants.map(v => v.size))];

                    uniqueSizes.forEach(size => {
                        const option = document.createElement('option');
                        option.value = size;
                        option.textContent = size;
                        sizeOptionsSelect.appendChild(option);
                    });

                    // Nếu có biến thể, cập nhật thông tin ban đầu cho size và color
                    if (variants.length > 0) {
                        const firstVariant = variants[0];
                        updatePriceAndQuantity(firstVariant.size, firstVariant.color);
                    }

                })
                .catch(error => console.error('Error fetching product details:', error));
        }

        // Hiển thị các sản phẩm liên quan
        function displayRelatedProducts(products) {
            const relatedProductsContainer = document.getElementById('related-products');
            relatedProductsContainer.innerHTML = ''; // Clear previous content

            // Giới hạn số lượng sản phẩm hiển thị là 4
            const limitedProducts = products.slice(0, 4); // Chỉ lấy 4 sản phẩm đầu tiên

            limitedProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('col');
                productCard.innerHTML = `
                <div class="product-card text-center position-relative">
                    <img src="${product.image}" class="product-img mx-auto mt-2" alt="Product Image" loading="lazy" style="width: 100%; height: auto;">
                    <div class="product-info">
                        <h6 class="product-category text-secondary">${product.type}</h6>
                        <h6 class="product-name text-dark">${product.name}</h6>
                        <div class="hover-content">
                            <a href="product_detail.html?id=${product.id}" class="btn btn-outline-dark mb-2">Xem chi tiết</a>
                            <button class="btn btn-outline-dark">Thêm vào yêu thích</button>
                        </div>
                    </div>
                </div>
            `;
                relatedProductsContainer.appendChild(productCard);
            });
        }

        // Xử lý sự kiện thay đổi kích cỡ và màu sắc
        document.getElementById('size-options').addEventListener('change', function () {
            const selectedSize = this.value;
            if (!selectedSize) return;

            const colorOptionsSelect = document.getElementById('color-options');
            colorOptionsSelect.innerHTML = ''; // Xóa các lựa chọn màu cũ
            colorOptionsSelect.disabled = false; // Kích hoạt dropdown màu sắc

            const filteredVariants = variants.filter(v => v.size == selectedSize);

            const uniqueColors = [...new Set(filteredVariants.map(v => v.color))];
            uniqueColors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorOptionsSelect.appendChild(option);
            });

            updatePriceAndQuantity(selectedSize, colorOptionsSelect.value);
        });

        document.getElementById('color-options').addEventListener('change', function () {
            const selectedSize = document.getElementById('size-options').value;
            const selectedColor = this.value;
            if (!selectedSize || !selectedColor) return;

            updatePriceAndQuantity(selectedSize, selectedColor);
        });

        function updatePriceAndQuantity(size, color) {
            if (!size || !color) return;

            const selectedVariant = variants.find(v => v.size == size && v.color == color);
            if (selectedVariant) {
                document.getElementById('product-price').textContent = selectedVariant.price.toLocaleString() + " VND";
                document.getElementById('product-quantity').textContent = `Số lượng còn lại: ${selectedVariant.quantity}`;
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
            return null;
        }

        // Xử lý sự kiện nút "Thêm vào giỏ"
        document.getElementById('add-to-cart-btn').addEventListener('click', function () {
            const accountId = getCookie('user') ? getCookie('user').id : null;

            if (!accountId) {
                alert("Không thể xác định tài khoản. Vui lòng đăng nhập lại!");
                window.location.href = '/login';
                return;
            }

            const selectedSize = document.getElementById('size-options').value;
            const selectedColor = document.getElementById('color-options').value;
            const quantity = parseInt(document.getElementById('product-quantity').value, 10);

            if (!selectedSize || !selectedColor || !quantity || quantity <= 0) {
                alert('Vui lòng chọn kích thước, màu sắc và nhập số lượng hợp lệ!');
                return;
            }

            const selectedVariant = variants.find(v => v.size == selectedSize && v.color == selectedColor);
            if (!selectedVariant) {
                alert('Sản phẩm không có sẵn với lựa chọn này!');
                return;
            }

            const cartItem = {
                accountId: accountId,
                productId: productId,
                variantId: selectedVariant.id,
                size: selectedSize,
                color: selectedColor,
                quantity: quantity,
                price: selectedVariant.price,
            };

            addToCart(cartItem);
        });

        function addToCart(item) {
            fetch('http://localhost:8080/api/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(item),
            })
                .then(response => {
                    if (response.ok) {
                        alert('Thêm sản phẩm vào giỏ hàng thành công!');

                        // Cập nhật số lượng giỏ hàng trong giao diện
                        let cartCount = parseInt(localStorage.getItem('cartCount')) || 0;
                        cartCount += item.quantity;
                        localStorage.setItem('cartCount', cartCount);

                        const cartCountElement = document.getElementById('cart-count');
                        if (cartCountElement) {
                            cartCountElement.textContent = cartCount;
                        } else {
                            console.warn("Không tìm thấy phần tử #cart-count.");
                        }
                    } else {
                        alert('Thêm sản phẩm vào giỏ hàng thất bại!');
                    }
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    alert('Đã xảy ra lỗi khi thêm sản phẩm vào giỏ hàng!');
                });
        }



    </script>


</body>

</html>