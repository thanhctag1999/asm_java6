<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="/src/main/resources/static/css/cart.css">
    <title>Cart</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #243642;">
            <div class="container">
                <!-- Logo và tên thương hiệu -->
                <a class="navbar-brand d-flex align-items-center" href="index.html"> <i
                        class="fa-brands fa-strava fa-2x me-2 text-light"></i> <span class="fw-bold text-light">Conan
                        Store</span>
                </a>
                <!-- Nút bật/tắt cho thiết bị di động -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Menu điều hướng -->
                <div class="collapse navbar-collapse" id="navbarContent">
                    <!-- Menu chính -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active text-light" href="index.html">Trang chủ</a>
                        </li>
                        <li class="nav-item"><a class="nav-link text-light" href="about.html">Về chúng tôi</a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="product.html">Sản phẩm</a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="contact.html">Liên hệ</a></li>
                    </ul>

                    <!-- search -->
                    <div class="searchbar">
                        <div class="searchbar-wrapper">
                            <div class="searchbar-left">
                                <div class="search-icon-wrapper">
                                    <span class="search-icon searchbar-icon"> <svg xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24">
                                            <path
                                                d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                                            </path>
                                        </svg>
                                    </span>
                                </div>
                            </div>

                            <div class="searchbar-center">
                                <div class="searchbar-input-spacer"></div>

                                <input type="text" class="searchbar-input" maxlength="2048" name="q"
                                    autocapitalize="off" autocomplete="off" title="Search" role="combobox"
                                    placeholder="Search Google">
                            </div>

                            <div class="searchbar-right">
                                <svg class="voice-search" role="button" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24">
                                    <path fill="#4285f4"
                                        d="m12 15c1.66 0 3-1.31 3-2.97v-7.02c0-1.66-1.34-3.01-3-3.01s-3 1.34-3 3.01v7.02c0 1.66 1.34 2.97 3 2.97z">
                                    </path>
                                    <path fill="#34a853" d="m11 18.08h2v3.92h-2z"></path>
                                    <path fill="#fbbc05"
                                        d="m7.05 16.87c-1.27-1.33-2.05-2.83-2.05-4.87h2c0 1.45 0.56 2.42 1.47 3.38v0.32l-1.15 1.18z">
                                    </path>
                                    <path fill="#ea4335"
                                        d="m12 16.93a4.97 5.25 0 0 1 -3.54 -1.55l-1.41 1.49c1.26 1.34 3.02 2.13 4.95 2.13 3.87 0 6.99-2.92 6.99-7h-1.99c0 2.92-2.24 4.93-5 4.93z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Giỏ hàng và tài khoản người dùng -->
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link text-light" href="cart.html"> <i
                                    class="fa-solid fa-cart-shopping me-2"></i>
                            </a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="profile.html"> <i
                                    class="fa-solid fa-user me-2"></i>
                            </a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="login.html"> <i
                                    class="fa-solid fa-right-from-bracket me-2"></i></a></li>

                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <div class="container mb-5">
        <h4 class="fw-bold" style="color: #76ABAE;">Giỏ hàng</h4>
        <p class="text-muted">Sản phẩm bạn đã chọn</p>
        <div class="d-flex">
            <a href="" class="btn btn-dark me-3">Mua tất cả sản phẩm</a>
            <h6 class="ms-3 mt-3">Tổng tiền: <span id="cartTotal">0₫</span></h6>
        </div>

        <hr>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Tên sản phẩm</th>
                    <th>Kích cỡ</th>
                    <th>Hình ảnh</th>
                    <th>Màu sắc</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cartItems">
                <div id="cart-container">
                    <!-- Danh sách các sản phẩm sẽ được hiển thị ở đây -->
                </div>
            </tbody>
        </table>
    </div>
    <script>
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000)); // Set expiry time for cookie
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))}; expires=${expires.toUTCString()}; path=/`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
            return null;
        }

        // Fetch accountId from cookie
        const accountId = getCookie('user') ? getCookie('user').id : null;
        console.log(accountId);

        // Fetch cart items from the API
        fetch(`http://localhost:8080/api/cart/items?accountId=${accountId}`)
            .then(response => response.json())
            .then(cartItems => {
                const cartItemsContainer = document.getElementById('cartItems');
                cartItemsContainer.innerHTML = '';

                cartItems.forEach(item => {
                    const product = item.product;
                    const variant = item.variant;
                    const cartItemHtml = `
    <tr data-id="${item.id}">
        <td>${product.name}</td>
        <td>${variant.size}</td>
        <td><img src="${product.image}" alt="${product.name}" class="cart-item-image" width="100" height="100"></td>
        <td>${variant.color}</td>
        <td>
            <input type="number" value="${item.quantity}" data-id="${item.id}" min="1" class="quantity-input"
                onchange="updateCartItemQuantity(${item.id}, this.value)">
        </td>
        <td class="item-total">${variant.price * item.quantity}₫</td>
        <td><button class="btn btn-dark" onclick="removeItem(${item.id})">Xóa</button></td>
        <td><button class="btn btn-dark" onclick="buyNow(${item.id})">Mua Ngay</button></td>
    </tr>
    `;
                    cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                });

                updateCartTotal(cartItems);
            })
            .catch(error => {
                console.error('Error fetching cart items:', error);
            });

        // Update cart item quantity in the backend
        function updateCartItemQuantity(itemId, newQuantity) {
            if (newQuantity <= 0) { alert('Số lượng phải lớn hơn 0'); return; }
            fetch(`http://localhost:8080/api/cart/update/${itemId}?quantity=${newQuantity}`, { method: 'PUT' })
                .then(response => {
                    if (response.headers.get('Content-Type').includes('application/json')) {
                        return response.json();
                    } else {
                        return response.text();  // Return raw text if not JSON
                    }
                })
                .then(data => {
                    if (typeof data === 'string') {
                        alert(data);  // If response is text, show it
                    } else {
                        if (data.success) {
                            alert('Số lượng đã được cập nhật.');
                            updateCartItemInUI(itemId, newQuantity);
                        } else {
                            alert(data.message || 'Error updating cart item.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating cart item:', error);
                    alert('Có lỗi xảy ra khi cập nhật giỏ hàng.');
                });

        }

        // Update the cart item UI after quantity is updated
        function updateCartItemInUI(itemId, newQuantity) {
            const cartItemRow = document.querySelector(`tr[data-id="${itemId}"]`);
            const quantityInput = cartItemRow.querySelector('.quantity-input');
            const priceCell = cartItemRow.querySelector('.item-total');

            quantityInput.value = newQuantity;
            const price = parseFloat(priceCell.textContent) / (newQuantity - 1); // Get price per item
            priceCell.textContent = `${price * newQuantity}₫`;

            updateCartTotal();
        }

        // Update the total price of the cart
        function updateCartTotal(cartItems) {
            let total = 0;
            cartItems.forEach(item => {
                total += item.variant.price * item.quantity;
            });
            document.getElementById('cartTotal').innerText = `${total}₫`;
        }

        function removeItem(itemId) {
            fetch(`http://localhost:8080/api/cart/remove/${itemId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);  // Hiển thị thông báo thành công
                        updateCartUI();  // Cập nhật lại giỏ hàng
                    } else {
                        alert("Lỗi khi xóa sản phẩm: " + data.message);  // Hiển thị thông báo lỗi
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gọi API:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm.');
                });
        }




        function updateCartUI() {
            // Lấy lại accountId từ cookie
            const accountId = getCookie('user') ? getCookie('user').id : null;

            if (!accountId) {
                alert('Không tìm thấy tài khoản.');
                return;
            }

            // Gọi lại API lấy giỏ hàng hiện tại
            fetch(`http://localhost:8080/api/cart/items?accountId=${accountId}`)
                .then(response => response.json())
                .then(cartItems => {
                    const cartItemsContainer = document.getElementById('cartItems');
                    cartItemsContainer.innerHTML = '';  // Xóa danh sách giỏ hàng hiện tại

                    // Nếu không có sản phẩm trong giỏ
                    if (cartItems.length === 0) {
                        cartItemsContainer.innerHTML = '<tr><td colspan="8" class="text-center">Giỏ hàng của bạn đang trống.</td></tr>';
                        document.getElementById('cartTotal').innerText = '0₫';  // Cập nhật tổng tiền
                        return;
                    }

                    // Lặp qua các sản phẩm trong giỏ hàng và hiển thị lại
                    cartItems.forEach(item => {
                        const product = item.product;
                        const variant = item.variant;
                        const cartItemHtml = `
                    <tr data-id="${item.id}">
                        <td>${product.name}</td>
                        <td>${variant.size}</td>
                        <td><img src="${product.image}" alt="${product.name}" class="cart-item-image" width="100" height="100"></td>
                        <td>${variant.color}</td>
                        <td>
                            <input type="number" value="${item.quantity}" data-id="${item.id}" min="1" class="quantity-input"
                                onchange="updateCartItemQuantity(${item.id}, this.value)">
                        </td>
                        <td class="item-total">${variant.price * item.quantity}₫</td>
                        <td><button class="btn btn-dark" onclick="removeItem(${item.id})">Xóa</button></td>
                        <td><button class="btn btn-dark" onclick="buyNow(${item.id})">Mua Ngay</button></td>
                    </tr>
                `;
                        cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                    });

                    // Cập nhật tổng tiền của giỏ hàng
                    updateCartTotal(cartItems);
                })
                .catch(error => {
                    console.error('Lỗi khi tải lại giỏ hàng:', error);
                    alert('Có lỗi xảy ra khi làm mới giỏ hàng.');
                });
        }


        // Handle "Buy Now" action
        function buyNow(productId) {
            alert(`Mua ngay sản phẩm ID: ${productId}`);
            // You can redirect to the checkout page here
        }

        // Remove item from cart

    </script>

</body>

</html>